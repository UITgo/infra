version: "3.9"
name: uitgo
networks: { uitgo-net: {} }
volumes: { pg_data: {} }

x-hc: &hc
  interval: 5s
  timeout: 3s
  retries: 30
  start_period: 10s

services:
  # ===== Core infra =====
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *hc

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports: ["2181:2181"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc -w 2 localhost 2181 | grep imok"]
      <<: *hc

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports: ["9092:9092","29092:29092"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      <<: *hc

  mongo:
    image: mongo:7
    ports: ["27017:27017"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      <<: *hc

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: uitgo
      POSTGRES_PASSWORD: uitgo
      POSTGRES_DB: tripdb
    ports: ["5432:5432"]
    volumes: ["pg_data:/var/lib/postgresql/data"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uitgo -d tripdb"]
      <<: *hc

  osrm:
    image: osrm/osrm-backend
    command: osrm-routed --algorithm mld /data/vietnam-latest.osrm
    volumes: ["./maps:/data"]
    ports: ["5000:5000"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 5000"]
      <<: *hc

  # ===== Domain services =====
  # TODO(ModuleA-Shard): Multi-region driver-stream sharding
  # Option 2: 2 separate containers for HCM and HN regions
  driver-stream-hcm:
    build: ../driver-stream
    container_name: driver-stream-hcm
    environment:
      REDIS_ADDR: redis:6379
      REDIS_URL: redis://redis:6379/0  # TODO(ModuleA-Shard): Could use different DB index per region
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC_LOCATION: driver.location.hcm  # TODO(ModuleA-Shard): Could use different topic per region
      OSRM_BASE_URL: http://osrm:5000
      HTTP_ADDR: ":8080"
      GRPC_ADDR: ":50052"
    depends_on:
      - redis
      - kafka
      - osrm
    ports: ["8081:8080"]  # Host port 8081 for HCM
    expose: ["50052"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz >/dev/null || exit 1"]
      <<: *hc

  driver-stream-hn:
    build: ../driver-stream
    container_name: driver-stream-hn
    environment:
      REDIS_ADDR: redis:6379
      REDIS_URL: redis://redis:6379/1  # TODO(ModuleA-Shard): Different DB index for HN region
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC_LOCATION: driver.location.hn  # TODO(ModuleA-Shard): Different topic for HN
      OSRM_BASE_URL: http://osrm:5000
      HTTP_ADDR: ":8080"
      GRPC_ADDR: ":50053"  # Different gRPC port to avoid conflict
    depends_on:
      - redis
      - kafka
      - osrm
    ports: ["8082:8080"]  # Host port 8082 for HN
    expose: ["50053"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz >/dev/null || exit 1"]
      <<: *hc

  user-service:
    build: ../user-service
    env_file:
      - ../user-service/.env 
    environment:
      MONGO_URL: mongodb://mongo:27017/uitgo
      PORT: 3001
      NODE_ENV: production
    expose: ["50051"]                  # gRPC nội bộ
    volumes:
      - ../proto:/app/proto:ro         # mount proto cho Nest gRPC
    depends_on:
      - mongo
    ports: ["3001:3001"]               # REST test
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3001/healthz >/dev/null || exit 1"]
      <<: *hc

  # TODO(ModuleA-CQRS): Trip service split into command (write) and query (read) services
  trip-command-service:
    build: ../trip-command-service
    environment:
      # TODO(ModuleA-CQRS): Command service uses PRIMARY_DB_URL for writes
      PRIMARY_DB_URL: postgresql://uitgo:uitgo@postgres:5432/tripdb?schema=public
      DATABASE_URL: postgresql://uitgo:uitgo@postgres:5432/tripdb?schema=public # Fallback
      POSTGRES_URL: postgres://uitgo:uitgo@postgres:5432/tripdb?sslmode=disable

      KAFKA_BROKERS: kafka:9092
      PORT: 3002
      DRIVER_STREAM_URL: driver-stream-hcm:50052  # Legacy, keep for compatibility
      # TODO(ModuleA-Shard): Region-based sharding URLs for driver-stream
      # Option 2: 2 separate containers - HCM and HN
      DRIVER_STREAM_HCM_URL: http://driver-stream-hcm:8080
      DRIVER_STREAM_HN_URL: http://driver-stream-hn:8080
      USER_GRPC_URL: user-service:50051
      OSRM_BASE_URL: http://osrm:5000
      NODE_ENV: production
    volumes:
      - ../proto:/app/proto:ro
    depends_on:
      - postgres
      - kafka
      - driver-stream-hcm
      - driver-stream-hn
      - osrm
      - user-service
    ports: ["3002:3002"]
    networks: [uitgo-net]
    command: ["sh","-lc","npx prisma migrate deploy && node dist/main.js"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3002/healthz >/dev/null || exit 1"]
      <<: *hc

  trip-query-service:
    build: ../trip-query-service
    environment:
      # TODO(ModuleA-CQRS): Query service uses READ_DB_URL (read replica in production)
      # In local, READ_DB_URL = PRIMARY_DB_URL (same DB)
      READ_DB_URL: postgresql://uitgo:uitgo@postgres:5432/tripdb?schema=public
      DATABASE_URL: postgresql://uitgo:uitgo@postgres:5432/tripdb?schema=public # Fallback

      REDIS_URL: redis:6379
      PORT: 3003
      NODE_ENV: production
    depends_on:
      - postgres
      - redis
    ports: ["3003:3003"]
    networks: [uitgo-net]
    command: ["sh","-lc","npx prisma generate && node dist/main.js"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3003/healthz >/dev/null || exit 1"]
      <<: *hc

  auth-service:
    build: ../auth-service
    env_file:
    - ../auth-service/.env                   
    environment:
      PORT: 3000                   
      NODE_ENV: development         
    ports:
      - "3000:3000"                
    networks:
      - uitgo-net
    depends_on:
       - mongo
       
  gateway-service:
    build: ../gateway-service
    environment:
      PORT: 3004
      AUTH_BASE_URL: http://auth-service:3000
      USER_BASE_URL: http://user-service:3001
      # TODO(ModuleA-CQRS): Split trip routes between command and query services
      TRIP_COMMAND_BASE_URL: http://trip-command-service:3002
      TRIP_QUERY_BASE_URL: http://trip-query-service:3003
      DRIVER_STREAM_BASE_URL: http://driver-stream-hcm:8080  # Legacy, for backward compatibility
    depends_on:
      - auth-service
      - user-service
      - trip-command-service
      - trip-query-service
      - driver-stream-hcm
      - driver-stream-hn
    ports:
      - "3004:3004"
    networks:
      - uitgo-net
