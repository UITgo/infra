version: "3.9"
name: uitgo
networks: { uitgo-net: {} }
volumes: { pg_data: {} }

x-hc: &hc
  interval: 5s
  timeout: 3s
  retries: 30
  start_period: 10s

services:
  # ===== Core infra =====
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *hc

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports: ["2181:2181"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc -w 2 localhost 2181 | grep imok"]
      <<: *hc

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports: ["9092:9092","29092:29092"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      <<: *hc

  mongo:
    image: mongo:7
    ports: ["27017:27017"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      <<: *hc

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: uitgo
      POSTGRES_PASSWORD: uitgo
      POSTGRES_DB: tripdb
    ports: ["5432:5432"]
    volumes: ["pg_data:/var/lib/postgresql/data"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uitgo -d tripdb"]
      <<: *hc

  osrm:
    image: osrm/osrm-backend
    command: osrm-routed --algorithm mld /data/vietnam-latest.osrm
    volumes: ["./maps:/data"]
    ports: ["5000:5000"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 5000"]
      <<: *hc

  # ===== Domain services =====
  driver-stream:
    build: ../driver-stream
    environment:
      REDIS_ADDR: redis:6379
      REDIS_URL: redis://redis:6379
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC_LOCATION: driver.location
      OSRM_BASE_URL: http://osrm:5000
      HTTP_ADDR: ":8080"
      GRPC_ADDR: ":50052"
    depends_on:
      - redis
      - kafka
      - osrm
    ports: ["8082:8080"]
    expose: ["50052"]
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz >/dev/null || exit 1"]
      <<: *hc

  user-service:
    build: ../user-service
    env_file:
      - ../user-service/.env 
    environment:
      MONGO_URL: mongodb://mongo:27017/uitgo
      PORT: 3001
      NODE_ENV: production
    expose: ["50051"]                  # gRPC ná»™i bá»™
    volumes:
      - ../proto:/app/proto:ro         # mount proto cho Nest gRPC
    depends_on:
      - mongo
    ports: ["3001:3001"]               # REST test
    networks: [uitgo-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3001/healthz >/dev/null || exit 1"]
      <<: *hc

  trip-service:
    build: ../trip-service
    environment:
      # Prisma cáº§n biáº¿n nÃ y ðŸ‘‡
      DATABASE_URL: postgresql://uitgo:uitgo@postgres:5432/tripdb?schema=public
      # (giá»¯ náº¿u code báº¡n cÃ²n dÃ¹ng POSTGRES_URL cho chá»— khÃ¡c)
      POSTGRES_URL: postgres://uitgo:uitgo@postgres:5432/tripdb?sslmode=disable

      REDIS_URL: redis:6379
      KAFKA_BROKERS: kafka:9092
      PORT: 3002
      DRIVER_STREAM_URL: driver-stream:50052
      USER_GRPC_URL: user-service:50051
      OSRM_BASE_URL: http://osrm:5000
      TRIP_GRPC_URL: 0.0.0.0:50051
      NODE_ENV: production
    volumes:
      - ../proto:/app/proto:ro
    depends_on:
      - postgres
      - redis
      - kafka
      - driver-stream
      - osrm
      - user-service
    ports: ["3002:3002"]
    networks: [uitgo-net]
    # (tuá»³ chá»n) Cháº¡y migrate trÆ°á»›c rá»“i start
    command: ["sh","-lc","npx prisma migrate deploy && node dist/main.js"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3002/healthz >/dev/null || exit 1"]
      <<: *hc

  auth-service:
    build: ../auth-service
    env_file:
    - ../auth-service/.env                   
    environment:
      PORT: 3000                   
      NODE_ENV: development         
    ports:
      - "3000:3000"                
    networks:
      - uitgo-net
    depends_on:
       - mongo
       
  gateway-service:
    build: ../gateway-service
    environment:
      PORT: 3004                     C
      AUTH_BASE_URL: http://auth-service:3000
      USER_BASE_URL: http://user-service:3001
      TRIP_BASE_URL: http://trip-service:3002
      DRIVER_STREAM_BASE_URL: http://driver-stream:8080
    depends_on:
      - auth-service
      - user-service
      - trip-service
      - driver-stream
    ports:
      - "3004:3004"
    networks:
      - uitgo-net
